version: '3.0'
services:
  db:
    image: mysql:8.0.23
    # caching_sha2_password.soをインストールする方法を見つけ出す
    command: [--default-authentication-plugin=mysql_native_password]
    environment:
      MYSQL_DATABASE: 'route_bucket_db'
      MYSQL_ROOT_PASSWORD: 'password'
      MYSQL_ROOT_HOST: '%'
      TZ: 'Asia/Tokyo'
    ports:
      - "3306:3306"

    # ↓の呪文がないとoperation not permittedになる
    # https://sunday-morning.app/posts/2020-07-29-docker-mysql8-mbind-operation-not-permitted
    cap_add:
      - SYS_NICE

  api:
    ports:
      - "8080:8080"
    build:
      context: .
      dockerfile: ./docker/api.Dockerfile
    environment:
      DATABASE_URL: mysql://root:password@db:3306/route_bucket_db
      RUST_LOG: info
      OSRM_ROOT: http://osrm:5000
      ORS_ROOT: http://ors:8080
    command: >
      bash -c "
        ./wait_for_db.sh &&
        diesel setup &&
        diesel migration run &&
        /app/target/release/route-bucket-backend"
    depends_on:
      - db
      - ors

  swagger:
    image: swaggerapi/swagger-ui:v3.45.1
    ports:
      - "10080:8080"
    volumes:
      - ./openapi/:/openapi/
    environment:
      # yamlなのにjsonに指定するのなぜ
      SWAGGER_JSON: /openapi/root.yml

  osrm:
    ports:
      - "5000:5000"
    build:
      context: .
      dockerfile: ./docker/osrm.Dockerfile
    command: osrm-routed --algorithm mld /data/map.osm.pbf

  ors:
    ports:
      - "12080:8080"
      - "9001:9001"
    build:
      context: ./
      dockerfile: ./docker/ors.Dockerfile
    environment:
      - BUILD_GRAPHS=True  # Forces the container to rebuild the graphs, e.g. when PBF is changed
      - "JAVA_OPTS=-Djava.awt.headless=true -server -XX:TargetSurvivorRatio=75 -XX:SurvivorRatio=64 -XX:MaxTenuringThreshold=3 -XX:+UseG1GC -XX:+ScavengeBeforeFullGC -XX:ParallelGCThreads=4 -Xms1g -Xmx2g"
      - "CATALINA_OPTS=-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=9001 -Dcom.sun.management.jmxremote.rmi.port=9001 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=localhost"

